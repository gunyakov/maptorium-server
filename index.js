#!/usr/bin/env node
//------------------------------------------------------------------------------
//Config
//------------------------------------------------------------------------------
global.config = require('./config.js');
//------------------------------------------------------------------------------
//Statistics
//------------------------------------------------------------------------------
global.stat = require('./src/statistics.js');
//------------------------------------------------------------------------------
//Wait функция
//------------------------------------------------------------------------------
global.wait = ms => new Promise(resolve => setTimeout(resolve, ms));
//------------------------------------------------------------------------------
//Express with socket IO
//------------------------------------------------------------------------------
const express = require("express");
const { createServer } = require("http");
const app = express();
const httpServer = createServer(app);
//------------------------------------------------------------------------------
//Logging service
//------------------------------------------------------------------------------
let Log = require("./src/log.js");
//------------------------------------------------------------------------------
//GPS service
//------------------------------------------------------------------------------
let GPS = require("./gps/gps");
GPS.start();
//------------------------------------------------------------------------------
//Static files for browser map
//------------------------------------------------------------------------------
app.use(express.static(process.cwd() + '/public'));
app.use('/poi', require('./routes/poi.js'));
//app.use('/map', require('./routes/map.js'));
app.use('/job', require('./routes/job.js'));
app.use('/tile', require('./routes/tile.js'));
app.use('/message', require('./routes/messages.js'));
app.use('/gps', require('./routes/gps.js'));
app.use('/core', require('./routes/core.js'));
//------------------------------------------------------------------------------
//Init
//------------------------------------------------------------------------------
(async() => {
  //----------------------------------------------------------------------------
  //Check proxy settings during start
  //----------------------------------------------------------------------------
  let httpEngine = require("./src/http-engine");
  await httpEngine.checkProxy(config);
  //----------------------------------------------------------------------------
  //Open port for incoming requests
  //----------------------------------------------------------------------------
  httpServer.listen(config.service.port);
  Log.make("info", "MAIN", "User UI -> http://127.0.0.1:" + config.service.port);
})();
