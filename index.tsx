#!/usr/bin/env node
//------------------------------------------------------------------------------
//Config
//------------------------------------------------------------------------------
import { config, prepareConfig } from "./config/index";
import { isConfigReady } from "./config/shared";
//------------------------------------------------------------------------------
//SocketIO
//------------------------------------------------------------------------------
import io from "./src/io";
//----------------------------------------------------------------------------
//Logging service
//----------------------------------------------------------------------------
import Log from "./src/log";
import { LogModules } from "./src/enum";
import wait from "./helpers/wait";
//------------------------------------------------------------------------------
//Express
//------------------------------------------------------------------------------
import style_router from "./routes/style";
import poi_router from "./routes/poi";
import job_router from "./routes/job";
import tile_router from "./routes/tile";
import gps_router from "./routes/gps";
import core_router from "./routes/core";
import map_router from "./routes/map";
//------------------------------------------------------------------------------
(async () => {
  //----------------------------------------------------------------------------
  //Prepare config
  //----------------------------------------------------------------------------
  while (!isConfigReady()) await wait(1000);
  //----------------------------------------------------------------------------
  const ExecFolder = process.cwd();
  //----------------------------------------------------------------------------
  //Express with socket IO
  //----------------------------------------------------------------------------
  let express = require("express");
  const app = express();
  const server = require("http").createServer(app);
  const path = require("path");
  //----------------------------------------------------------------------------
  //SocketIO init function
  //----------------------------------------------------------------------------
  io(server);
  //----------------------------------------------------------------------------
  //CORS requests enabling (for testing only)
  //----------------------------------------------------------------------------
  //const cors = require("cors");
  //app.use(cors());
  //----------------------------------------------------------------------------
  //Static files for browser map
  //----------------------------------------------------------------------------
  const staticPath = path.join(ExecFolder, "..", "maptorium-maplibre");
  app.use(express.static(staticPath));
  //----------------------------------------------------------------------------
  //  Style POST Handler
  //----------------------------------------------------------------------------
  app.use("/styles", style_router);
  //----------------------------------------------------------------------------
  //  POI API Handler
  //----------------------------------------------------------------------------
  app.use("/poi", poi_router);
  //----------------------------------------------------------------------------
  //  JOB API Handler
  //----------------------------------------------------------------------------
  app.use("/job", job_router);
  //----------------------------------------------------------------------------
  //  TILE API Handler
  //----------------------------------------------------------------------------
  app.use("/tile", tile_router);
  //----------------------------------------------------------------------------
  //  GPS API Handler
  //----------------------------------------------------------------------------
  app.use("/gps", gps_router);
  //----------------------------------------------------------------------------
  //  CORE API Handler
  //----------------------------------------------------------------------------
  app.use("/core", core_router);
  //----------------------------------------------------------------------------
  //  MAP API Handler
  app.use("/map", map_router);
  //----------------------------------------------------------------------------
  //Open port for incoming requests
  //----------------------------------------------------------------------------
  const port = config?.service?.port; //|| 9009;
  server.listen(port, () => {
    Log.info(LogModules.main, "User UI -> http://127.0.0.1:" + port);
  });
})().catch((error) => {
  console.error("Error during initialization:", error);
  process.exit(1);
});
